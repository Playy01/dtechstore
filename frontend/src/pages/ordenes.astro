---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Mis Órdenes - DTech">
  <div class="container">
    <h1>Mis Órdenes</h1>
    <div class="orders-list" id="ordersList"></div>
  </div>
</Layout>

<style>
  h1 {
    margin-bottom: 32px;
  }

  .orders-list {
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  .order-card {
    background: var(--bg-primary);
    padding: 24px;
    border-radius: var(--radius);
  }

  .order-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border);
  }

  .order-status {
    padding: 6px 12px;
    border-radius: var(--radius-sm);
    font-size: 14px;
    font-weight: 600;
  }

  .order-status.pending {
    background: #FFF3CD;
    color: #856404;
  }

  .order-status.completed {
    background: #D4EDDA;
    color: #155724;
  }

  .order-items {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .order-item {
    display: flex;
    gap: 16px;
    align-items: center;
  }

  .order-item img {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: var(--radius-sm);
  }
</style>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
  
  const supabase = createClient(
    'https://szfamthbjrsqctzgokx.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN6ZmFtdGhianJzcWN0emdva3giLCJyb2xlIjoiYW5vbiIsImlhdCI6MTczMjkyNzU3NCwiZXhwIjoyMDQ4NTAzNTc0fQ.Ej3haz4QlBUcrN4bfDLAKVQ_B8k3pp04'
  );

  async function loadOrders() {
    const { data: { user } } = await supabase.auth.getUser();
    
    if (!user) {
      window.location.href = '/login';
      return;
    }

    try {
      // Obtener el user_id de la tabla users
      const { data: userData } = await supabase
        .from('users')
        .select('id')
        .eq('email', user.email)
        .single();

      if (!userData) throw new Error('Usuario no encontrado');

      // Obtener órdenes del usuario
      const { data: orders, error } = await supabase
        .from('orders')
        .select(`
          *,
          order_items (
            *,
            products (*)
          )
        `)
        .eq('user_id', userData.id)
        .order('created_at', { ascending: false });

      if (error) throw error;

      displayOrders(orders || []);
    } catch (error: any) {
      console.error('Error:', error);
      const container = document.getElementById('ordersList');
      if (container) {
        container.innerHTML = '<p>Error al cargar las órdenes</p>';
      }
    }
  }

  function displayOrders(orders: any[]) {
    const container = document.getElementById('ordersList');
    if (!container) return;

    if (orders.length === 0) {
      container.innerHTML = '<p>No tienes órdenes aún</p>';
      return;
    }

    container.innerHTML = orders.map(order => `
      <div class="order-card">
        <div class="order-header">
          <div>
            <strong>Orden #${order.id}</strong>
            <p>${new Date(order.created_at).toLocaleDateString()}</p>
          </div>
          <div>
            <span class="order-status ${order.status}">${order.status}</span>
            <p><strong>Total: $${order.total.toFixed(2)}</strong></p>
          </div>
        </div>
        <a href="/orden/${order.id}" style="color: var(--primary)">Ver detalles →</a>
      </div>
    `).join('');
  }

  loadOrders();
</script>
