---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Realizar Pago - BananaTech">
  <div class="container">
    <div class="payment-layout">
      <div class="order-summary">
        <h2>Resumen del Pedido</h2>
        <div id="orderItems"></div>
        <div class="summary-total">
          <span>Total a Pagar:</span>
          <span class="total-amount" id="totalAmount">$0.00</span>
        </div>
      </div>

      <div class="payment-methods">
        <h1>M√©todo de Pago</h1>
        <p class="subtitle">Selecciona c√≥mo deseas pagar tu pedido</p>

        <div class="method-cards">
          <div class="method-card" id="bankTransferCard">
            <div class="method-icon">
              <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                <line x1="1" y1="10" x2="23" y2="10"></line>
              </svg>
            </div>
            <div class="method-info">
              <h3>Transferencia Bancaria</h3>
              <p>Paga directamente desde tu banco</p>
            </div>
            <div class="method-check">
              <input type="radio" name="paymentMethod" value="bank" id="bankRadio">
            </div>
          </div>

          <div class="method-card" id="mercadopagoCard">
            <div class="method-icon mercadopago">
              <svg width="40" height="40" viewBox="0 0 24 24" fill="currentColor">
                <path d="M15.5 2C11.4 2 8 5.4 8 9.5c0 1.8.6 3.4 1.7 4.7L2 22l1.4 1.4 7.8-7.8c1.3 1 2.9 1.7 4.7 1.7 4.1 0 7.5-3.4 7.5-7.5S19.6 2 15.5 2zm0 12c-2.5 0-4.5-2-4.5-4.5S13 5 15.5 5 20 7 20 9.5 18 14 15.5 14z"/>
              </svg>
            </div>
            <div class="method-info">
              <h3>Mercado Pago</h3>
              <p>Tarjetas, efectivo y m√°s</p>
            </div>
            <div class="method-check">
              <input type="radio" name="paymentMethod" value="mercadopago" id="mercadopagoRadio">
            </div>
          </div>
        </div>

        <!-- Formulario de Transferencia Bancaria -->
        <div class="payment-form" id="bankForm" style="display: none;">
          <h3>Datos para Transferencia</h3>
          <div class="bank-info">
            <div class="info-card">
              <div class="info-label">Banco:</div>
              <div class="info-value">Banco Nacional</div>
            </div>
            <div class="info-card">
              <div class="info-label">Titular:</div>
              <div class="info-value">BananaTech Store S.A.</div>
            </div>
            <div class="info-card">
              <div class="info-label">N√∫mero de Cuenta:</div>
              <div class="info-value">1234-5678-9012-3456</div>
            </div>
            <div class="info-card">
              <div class="info-label">IBAN:</div>
              <div class="info-value">ES12 1234 5678 9012 3456 7890</div>
            </div>
          </div>

          <div class="upload-section">
            <label class="upload-label">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
              </svg>
              <span>Subir Comprobante de Pago</span>
              <input type="file" id="proofUpload" accept="image/*,.pdf" style="display: none;">
            </label>
            <div id="fileName" class="file-name"></div>
          </div>

          <button class="btn-confirm" id="confirmBank">Confirmar Pago</button>
        </div>

        <!-- Formulario de Mercado Pago -->
        <div class="payment-form" id="mercadopagoForm" style="display: none;">
          <h3>Pagar con Mercado Pago</h3>
          <p class="mp-info">Ser√°s redirigido a Mercado Pago para completar tu pago de forma segura.</p>
          
          <div class="mp-button-container">
            <button class="btn-mercadopago" id="mercadopagoButton">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M15.5 2C11.4 2 8 5.4 8 9.5c0 1.8.6 3.4 1.7 4.7L2 22l1.4 1.4 7.8-7.8c1.3 1 2.9 1.7 4.7 1.7 4.1 0 7.5-3.4 7.5-7.5S19.6 2 15.5 2zm0 12c-2.5 0-4.5-2-4.5-4.5S13 5 15.5 5 20 7 20 9.5 18 14 15.5 14z"/>
              </svg>
              Pagar con Mercado Pago
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</Layout>

<style>
  .payment-layout {
    display: grid;
    grid-template-columns: 400px 1fr;
    gap: 40px;
    max-width: 1200px;
    margin: 0 auto;
  }

  .order-summary {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    padding: 32px;
    border-radius: var(--radius-lg);
    border: 2px solid var(--border);
    box-shadow: 0 8px 32px var(--shadow);
    height: fit-content;
    position: sticky;
    top: 100px;
  }

  .order-summary h2 {
    font-size: 24px;
    font-weight: 800;
    margin-bottom: 24px;
  }

  .order-item {
    display: flex;
    gap: 12px;
    padding: 16px 0;
    border-bottom: 1px solid var(--border);
  }

  .item-image {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: var(--radius-sm);
  }

  .item-details {
    flex: 1;
  }

  .item-name {
    font-weight: 700;
    margin-bottom: 4px;
  }

  .item-quantity {
    font-size: 14px;
    color: var(--text-secondary);
  }

  .summary-total {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 24px;
    padding-top: 24px;
    border-top: 2px solid var(--border);
    font-size: 18px;
    font-weight: 700;
  }

  .total-amount {
    font-size: 32px;
    color: var(--primary);
  }

  .payment-methods {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    padding: 40px;
    border-radius: var(--radius-lg);
    border: 2px solid var(--border);
    box-shadow: 0 8px 32px var(--shadow);
  }

  h1 {
    font-size: 36px;
    font-weight: 800;
    background: var(--bg-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 8px;
  }

  .subtitle {
    color: var(--text-secondary);
    margin-bottom: 32px;
  }

  .method-cards {
    display: flex;
    flex-direction: column;
    gap: 16px;
    margin-bottom: 32px;
  }

  .method-card {
    display: flex;
    align-items: center;
    gap: 20px;
    padding: 24px;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(10px);
    border: 2px solid var(--border);
    border-radius: 24px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .method-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 40px var(--shadow-lg);
    border-color: var(--primary);
  }

  .method-card.selected {
    border-color: var(--primary);
    background: rgba(99, 102, 241, 0.05);
  }

  .method-icon {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: rgba(99, 102, 241, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary);
  }

  .method-icon.mercadopago {
    background: linear-gradient(135deg, #009ee3, #0066cc);
    color: white;
  }

  .method-info {
    flex: 1;
  }

  .method-info h3 {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 4px;
  }

  .method-info p {
    font-size: 14px;
    color: var(--text-secondary);
  }

  .method-check input[type="radio"] {
    width: 24px;
    height: 24px;
    cursor: pointer;
  }

  .payment-form {
    animation: fadeInUp 0.5s ease-out;
  }

  .payment-form h3 {
    font-size: 24px;
    font-weight: 800;
    margin-bottom: 24px;
  }

  .bank-info {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
    margin-bottom: 32px;
  }

  .info-card {
    padding: 20px;
    background: var(--bg-secondary);
    border-radius: var(--radius);
  }

  .info-label {
    font-size: 12px;
    color: var(--text-secondary);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
  }

  .info-value {
    font-size: 16px;
    font-weight: 700;
    color: var(--text-primary);
  }

  .upload-section {
    margin-bottom: 24px;
  }

  .upload-label {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    padding: 40px;
    background: var(--bg-secondary);
    border: 2px dashed var(--border);
    border-radius: var(--radius);
    cursor: pointer;
    transition: all 0.3s;
  }

  .upload-label:hover {
    border-color: var(--primary);
    background: rgba(99, 102, 241, 0.05);
  }

  .file-name {
    margin-top: 12px;
    font-size: 14px;
    color: var(--text-secondary);
    text-align: center;
  }

  .btn-confirm, .btn-mercadopago {
    width: 100%;
    padding: 20px;
    border-radius: 24px;
    font-size: 18px;
    font-weight: 700;
    transition: all 0.3s;
  }

  .btn-confirm {
    background: var(--bg-gradient);
    color: white;
    box-shadow: 0 4px 16px var(--shadow-lg);
  }

  .btn-confirm:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 32px var(--shadow-lg);
  }

  .btn-mercadopago {
    background: linear-gradient(135deg, #009ee3, #0066cc);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    border: none;
    cursor: pointer;
  }

  .btn-mercadopago:hover {
    background: linear-gradient(135deg, #0088cc, #0055bb);
    transform: translateY(-4px);
    box-shadow: 0 8px 32px rgba(0, 158, 227, 0.3);
  }

  .mp-info {
    color: var(--text-secondary);
    margin-bottom: 24px;
    padding: 16px;
    background: var(--bg-secondary);
    border-radius: var(--radius);
  }

  .mp-button-container {
    margin-top: 24px;
  }

  @media (max-width: 968px) {
    .payment-layout {
      grid-template-columns: 1fr;
    }

    .order-summary {
      position: static;
    }

    .bank-info {
      grid-template-columns: 1fr;
    }
  }
</style>

<script src="https://sdk.mercadopago.com/js/v2"></script>
<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
  
  const supabase = createClient(
    'https://szfwntkbjrspcptzgoks.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN6ZndudGtianJzcGNwdHpnb2tzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MzcxODEsImV4cCI6MjA4MDExMzE4MX0.RHng44u3pPpUZwlb-W1KvoyCi7RTVNtmw7S7LjgG0G0'
  );

  // Funci√≥n para obtener sesi√≥n de cualquier storage
  function getSession() {
    // Intentar localStorage primero
    let isLoggedIn = localStorage.getItem('isLoggedIn');
    let userStr = localStorage.getItem('user');
    
    // Si no est√° en localStorage, intentar sessionStorage
    if (!isLoggedIn || !userStr) {
      isLoggedIn = sessionStorage.getItem('isLoggedIn');
      userStr = sessionStorage.getItem('user');
      
      // Si est√° en sessionStorage, copiar a localStorage
      if (isLoggedIn && userStr) {
        localStorage.setItem('isLoggedIn', isLoggedIn);
        localStorage.setItem('user', userStr);
        console.log('üìã Sesi√≥n copiada de sessionStorage a localStorage');
      }
    }
    
    return { isLoggedIn, userStr };
  }

  // Verificar sesi√≥n (solo log, no redirigir)
  function checkSession() {
    const { isLoggedIn, userStr } = getSession();
    
    console.log('=== VERIFICACI√ìN DE SESI√ìN EN PAGO ===');
    console.log('localStorage.isLoggedIn:', localStorage.getItem('isLoggedIn'));
    console.log('localStorage.user:', localStorage.getItem('user'));
    console.log('sessionStorage.isLoggedIn:', sessionStorage.getItem('isLoggedIn'));
    console.log('sessionStorage.user:', sessionStorage.getItem('user'));
    
    if (isLoggedIn === 'true' && userStr) {
      try {
        const user = JSON.parse(userStr);
        console.log('‚úÖ Usuario autenticado:', user);
        return true;
      } catch (e) {
        console.error('Error al parsear usuario:', e);
        return false;
      }
    }
    
    console.log('‚ö†Ô∏è No hay sesi√≥n activa en ning√∫n storage');
    return false;
  }

  // Solo verificar, no redirigir autom√°ticamente
  checkSession();

  function loadCart() {
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    const itemsContainer = document.getElementById('orderItems');
    const totalElement = document.getElementById('totalAmount');

    if (!itemsContainer || !totalElement) return;

    if (cart.length === 0) {
      window.location.href = '/carrito';
      return;
    }

    const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

    itemsContainer.innerHTML = cart.map((item) => `
      <div class="order-item">
        <img src="${item.image}" alt="${item.name}" class="item-image">
        <div class="item-details">
          <div class="item-name">${item.name}</div>
          <div class="item-quantity">${item.quantity} √ó $${item.price.toFixed(2)}</div>
        </div>
      </div>
    `).join('');

    totalElement.textContent = `$${total.toFixed(2)}`;
  }

  // Inicializar Mercado Pago
  const mp = new MercadoPago('APP_USR-98e2bb1d-0622-428e-a0dc-cda1b68fb817', {
    locale: 'es-MX'
  });

  // Manejo de selecci√≥n de m√©todo de pago
  const bankCard = document.getElementById('bankTransferCard');
  const mercadopagoCard = document.getElementById('mercadopagoCard');
  const bankRadio = document.getElementById('bankRadio');
  const mercadopagoRadio = document.getElementById('mercadopagoRadio');
  const bankForm = document.getElementById('bankForm');
  const mercadopagoForm = document.getElementById('mercadopagoForm');

  bankCard?.addEventListener('click', () => {
    bankRadio.checked = true;
    bankCard.classList.add('selected');
    mercadopagoCard?.classList.remove('selected');
    if (bankForm) bankForm.style.display = 'block';
    if (mercadopagoForm) mercadopagoForm.style.display = 'none';
  });

  mercadopagoCard?.addEventListener('click', () => {
    mercadopagoRadio.checked = true;
    mercadopagoCard.classList.add('selected');
    bankCard?.classList.remove('selected');
    if (mercadopagoForm) mercadopagoForm.style.display = 'block';
    if (bankForm) bankForm.style.display = 'none';
  });

  // Upload de comprobante
  document.getElementById('proofUpload')?.addEventListener('change', (e) => {
    const input = e.target;
    const fileName = document.getElementById('fileName');
    if (input.files && input.files[0] && fileName) {
      fileName.textContent = `Archivo seleccionado: ${input.files[0].name}`;
    }
  });

  // Confirmar pago bancario
  document.getElementById('confirmBank')?.addEventListener('click', async () => {
    // Verificar sesi√≥n
    const { isLoggedIn, userStr } = getSession();
    
    if (isLoggedIn !== 'true' || !userStr) {
      alert('Debes iniciar sesi√≥n para continuar');
      window.location.href = '/login?redirect=/pago';
      return;
    }
    
    const fileInput = document.getElementById('proofUpload');
    
    if (!fileInput.files || !fileInput.files[0]) {
      window.showNotification?.(
        'Por favor sube el comprobante de pago',
        'warning',
        'Comprobante Requerido'
      );
      return;
    }

    await processOrder('bank_transfer');
  });

  // Pago con Mercado Pago
  document.getElementById('mercadopagoButton')?.addEventListener('click', async () => {
    // Verificar sesi√≥n al hacer click (intentar ambos storages)
    const { isLoggedIn, userStr } = getSession();
    
    console.log('=== CLICK EN BOT√ìN MERCADO PAGO ===');
    console.log('isLoggedIn:', isLoggedIn);
    console.log('userStr existe:', !!userStr);
    console.log('userStr length:', userStr?.length);
    
    if (isLoggedIn !== 'true' || !userStr) {
      console.log('‚ùå No hay sesi√≥n v√°lida');
      alert('Debes iniciar sesi√≥n para continuar con el pago.\n\nSer√°s redirigido al login.');
      window.location.href = '/login?redirect=/pago';
      return;
    }
    
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    const user = JSON.parse(userStr);

    if (cart.length === 0) {
      alert('Tu carrito est√° vac√≠o');
      window.location.href = '/carrito';
      return;
    }

    console.log('=== INICIANDO PAGO CON MERCADO PAGO ===');
    console.log('Usuario:', user);
    console.log('Carrito:', cart);
    
    try {
      console.log('Creando orden de pago...');
      
      // Crear preferencia de pago
      const items = cart.map(item => ({
        title: item.name,
        unit_price: parseFloat(item.price),
        quantity: parseInt(item.quantity),
        currency_id: 'MXN'
      }));

      const preference = {
        items: items,
        payer: {
          name: user.name || user.email,
          email: user.email
        },
        back_urls: {
          success: window.location.origin + '/pago/success',
          failure: window.location.origin + '/pago/failure',
          pending: window.location.origin + '/pago/pending'
        },
        auto_return: 'approved',
        external_reference: `bananatech_${Date.now()}_${user.id}`
      };

      console.log('Preferencia creada:', preference);
      console.log('Abriendo checkout de Mercado Pago...');

      // Crear checkout
      const checkout = mp.checkout({
        preference: preference
      });

      checkout.open();
      console.log('‚úÖ Checkout abierto exitosamente');
      
    } catch (error) {
      console.error('‚ùå Error al crear checkout:', error);
      alert('Error al crear la orden de pago. Por favor intenta de nuevo.');
    }
  });

  async function processOrder(paymentMethod) {
    const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
    const userStr = localStorage.getItem('user');
    
    if (!isLoggedIn || !userStr) {
      window.location.href = '/login';
      return;
    }

    const user = JSON.parse(userStr);
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');

    try {
      // Calcular total
      const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

      // Crear orden
      const { data: order, error: orderError } = await supabase
        .from('orders')
        .insert([{
          user_id: user.id,
          total,
          status: 'pending'
        }])
        .select()
        .single();

      if (orderError) throw orderError;

      // Crear items de la orden
      const orderItems = cart.map((item) => ({
        order_id: order.id,
        product_id: parseInt(item.id),
        quantity: item.quantity,
        price: item.price
      }));

      const { error: itemsError } = await supabase
        .from('order_items')
        .insert(orderItems);

      if (itemsError) throw itemsError;

      localStorage.removeItem('cart');
      window.dispatchEvent(new Event('cartUpdated'));
      
      window.showNotification?.(
        `Pago procesado exitosamente mediante ${paymentMethod === 'bank_transfer' ? 'transferencia bancaria' : 'PayPal'}`,
        'success',
        '¬°Compra Realizada!'
      );
      
      setTimeout(() => {
        window.location.href = '/ordenes';
      }, 2000);
    } catch (error) {
      console.error('Error:', error);
      window.showNotification?.(
        error.message || 'Hubo un problema al procesar tu orden',
        'error',
        'Error'
      );
    }
  }

  loadCart();
</script>
