---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Realizar Pago - DTech">
  <div class="container">
    <div class="payment-layout">
      <div class="order-summary">
        <h2>Resumen del Pedido</h2>
        <div id="orderItems"></div>
        <div class="summary-total">
          <span>Total a Pagar:</span>
          <span class="total-amount" id="totalAmount">$0.00</span>
        </div>
      </div>

      <div class="payment-methods">
        <h1>Método de Pago</h1>
        <p class="subtitle">Selecciona cómo deseas pagar tu pedido</p>

        <div class="method-cards">
          <div class="method-card" id="bankTransferCard">
            <div class="method-icon">
              <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                <line x1="1" y1="10" x2="23" y2="10"></line>
              </svg>
            </div>
            <div class="method-info">
              <h3>Transferencia Bancaria</h3>
              <p>Paga directamente desde tu banco</p>
            </div>
            <div class="method-check">
              <input type="radio" name="paymentMethod" value="bank" id="bankRadio">
            </div>
          </div>

          <div class="method-card" id="paypalCard">
            <div class="method-icon paypal">
              <svg width="40" height="40" viewBox="0 0 24 24" fill="currentColor">
                <path d="M7.076 21.337H2.47a.641.641 0 0 1-.633-.74L4.944 3.72a.77.77 0 0 1 .76-.653h8.53c2.347 0 4.203.87 5.076 2.386.764 1.325.825 2.88.179 4.625-.011.03-.022.06-.034.09-.857 2.419-2.553 3.652-5.04 3.652H11.73a.77.77 0 0 0-.76.653l-.542 3.435-.011.07-.637 4.04a.641.641 0 0 1-.633.74h-.071z"/>
              </svg>
            </div>
            <div class="method-info">
              <h3>PayPal</h3>
              <p>Pago rápido y seguro</p>
            </div>
            <div class="method-check">
              <input type="radio" name="paymentMethod" value="paypal" id="paypalRadio">
            </div>
          </div>
        </div>

        <!-- Formulario de Transferencia Bancaria -->
        <div class="payment-form" id="bankForm" style="display: none;">
          <h3>Datos para Transferencia</h3>
          <div class="bank-info">
            <div class="info-card">
              <div class="info-label">Banco:</div>
              <div class="info-value">Banco Nacional</div>
            </div>
            <div class="info-card">
              <div class="info-label">Titular:</div>
              <div class="info-value">DTech Store S.A.</div>
            </div>
            <div class="info-card">
              <div class="info-label">Número de Cuenta:</div>
              <div class="info-value">1234-5678-9012-3456</div>
            </div>
            <div class="info-card">
              <div class="info-label">IBAN:</div>
              <div class="info-value">ES12 1234 5678 9012 3456 7890</div>
            </div>
          </div>

          <div class="upload-section">
            <label class="upload-label">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
              </svg>
              <span>Subir Comprobante de Pago</span>
              <input type="file" id="proofUpload" accept="image/*,.pdf" style="display: none;">
            </label>
            <div id="fileName" class="file-name"></div>
          </div>

          <button class="btn-confirm" id="confirmBank">Confirmar Pago</button>
        </div>

        <!-- Formulario de PayPal -->
        <div class="payment-form" id="paypalForm" style="display: none;">
          <h3>Pagar con PayPal</h3>
          <p class="paypal-info">Serás redirigido a PayPal para completar tu pago de forma segura.</p>
          
          <div class="paypal-button-container">
            <button class="btn-paypal" id="paypalButton">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M7.076 21.337H2.47a.641.641 0 0 1-.633-.74L4.944 3.72a.77.77 0 0 1 .76-.653h8.53c2.347 0 4.203.87 5.076 2.386.764 1.325.825 2.88.179 4.625-.011.03-.022.06-.034.09-.857 2.419-2.553 3.652-5.04 3.652H11.73a.77.77 0 0 0-.76.653l-.542 3.435-.011.07-.637 4.04a.641.641 0 0 1-.633.74h-.071z"/>
              </svg>
              Pagar con PayPal
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</Layout>

<style>
  .payment-layout {
    display: grid;
    grid-template-columns: 400px 1fr;
    gap: 40px;
    max-width: 1200px;
    margin: 0 auto;
  }

  .order-summary {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    padding: 32px;
    border-radius: var(--radius-lg);
    border: 2px solid var(--border);
    box-shadow: 0 8px 32px var(--shadow);
    height: fit-content;
    position: sticky;
    top: 100px;
  }

  .order-summary h2 {
    font-size: 24px;
    font-weight: 800;
    margin-bottom: 24px;
  }

  .order-item {
    display: flex;
    gap: 12px;
    padding: 16px 0;
    border-bottom: 1px solid var(--border);
  }

  .item-image {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: var(--radius-sm);
  }

  .item-details {
    flex: 1;
  }

  .item-name {
    font-weight: 700;
    margin-bottom: 4px;
  }

  .item-quantity {
    font-size: 14px;
    color: var(--text-secondary);
  }

  .summary-total {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 24px;
    padding-top: 24px;
    border-top: 2px solid var(--border);
    font-size: 18px;
    font-weight: 700;
  }

  .total-amount {
    font-size: 32px;
    color: var(--primary);
  }

  .payment-methods {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    padding: 40px;
    border-radius: var(--radius-lg);
    border: 2px solid var(--border);
    box-shadow: 0 8px 32px var(--shadow);
  }

  h1 {
    font-size: 36px;
    font-weight: 800;
    background: var(--bg-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 8px;
  }

  .subtitle {
    color: var(--text-secondary);
    margin-bottom: 32px;
  }

  .method-cards {
    display: flex;
    flex-direction: column;
    gap: 16px;
    margin-bottom: 32px;
  }

  .method-card {
    display: flex;
    align-items: center;
    gap: 20px;
    padding: 24px;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(10px);
    border: 2px solid var(--border);
    border-radius: 24px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .method-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 40px var(--shadow-lg);
    border-color: var(--primary);
  }

  .method-card.selected {
    border-color: var(--primary);
    background: rgba(99, 102, 241, 0.05);
  }

  .method-icon {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: rgba(99, 102, 241, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary);
  }

  .method-icon.paypal {
    background: rgba(0, 48, 135, 0.1);
    color: #003087;
  }

  .method-info {
    flex: 1;
  }

  .method-info h3 {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 4px;
  }

  .method-info p {
    font-size: 14px;
    color: var(--text-secondary);
  }

  .method-check input[type="radio"] {
    width: 24px;
    height: 24px;
    cursor: pointer;
  }

  .payment-form {
    animation: fadeInUp 0.5s ease-out;
  }

  .payment-form h3 {
    font-size: 24px;
    font-weight: 800;
    margin-bottom: 24px;
  }

  .bank-info {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
    margin-bottom: 32px;
  }

  .info-card {
    padding: 20px;
    background: var(--bg-secondary);
    border-radius: var(--radius);
  }

  .info-label {
    font-size: 12px;
    color: var(--text-secondary);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
  }

  .info-value {
    font-size: 16px;
    font-weight: 700;
    color: var(--text-primary);
  }

  .upload-section {
    margin-bottom: 24px;
  }

  .upload-label {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    padding: 40px;
    background: var(--bg-secondary);
    border: 2px dashed var(--border);
    border-radius: var(--radius);
    cursor: pointer;
    transition: all 0.3s;
  }

  .upload-label:hover {
    border-color: var(--primary);
    background: rgba(99, 102, 241, 0.05);
  }

  .file-name {
    margin-top: 12px;
    font-size: 14px;
    color: var(--text-secondary);
    text-align: center;
  }

  .btn-confirm, .btn-paypal {
    width: 100%;
    padding: 20px;
    border-radius: 24px;
    font-size: 18px;
    font-weight: 700;
    transition: all 0.3s;
  }

  .btn-confirm {
    background: var(--bg-gradient);
    color: white;
    box-shadow: 0 4px 16px var(--shadow-lg);
  }

  .btn-confirm:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 32px var(--shadow-lg);
  }

  .btn-paypal {
    background: #0070BA;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
  }

  .btn-paypal:hover {
    background: #003087;
    transform: translateY(-4px);
    box-shadow: 0 8px 32px rgba(0, 48, 135, 0.3);
  }

  .paypal-info {
    color: var(--text-secondary);
    margin-bottom: 24px;
    padding: 16px;
    background: var(--bg-secondary);
    border-radius: var(--radius);
  }

  @media (max-width: 968px) {
    .payment-layout {
      grid-template-columns: 1fr;
    }

    .order-summary {
      position: static;
    }

    .bank-info {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  const API_URL = 'http://localhost:8080/api';

  function loadCart() {
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    const itemsContainer = document.getElementById('orderItems');
    const totalElement = document.getElementById('totalAmount');

    if (!itemsContainer || !totalElement) return;

    if (cart.length === 0) {
      window.location.href = '/carrito';
      return;
    }

    const total = cart.reduce((sum: number, item: any) => sum + (item.price * item.quantity), 0);

    itemsContainer.innerHTML = cart.map((item: any) => `
      <div class="order-item">
        <img src="${item.image}" alt="${item.name}" class="item-image">
        <div class="item-details">
          <div class="item-name">${item.name}</div>
          <div class="item-quantity">${item.quantity} × $${item.price.toFixed(2)}</div>
        </div>
      </div>
    `).join('');

    totalElement.textContent = `$${total.toFixed(2)}`;
  }

  // Manejo de selección de método de pago
  const bankCard = document.getElementById('bankTransferCard');
  const paypalCard = document.getElementById('paypalCard');
  const bankRadio = document.getElementById('bankRadio') as HTMLInputElement;
  const paypalRadio = document.getElementById('paypalRadio') as HTMLInputElement;
  const bankForm = document.getElementById('bankForm');
  const paypalForm = document.getElementById('paypalForm');

  bankCard?.addEventListener('click', () => {
    bankRadio.checked = true;
    bankCard.classList.add('selected');
    paypalCard?.classList.remove('selected');
    if (bankForm) bankForm.style.display = 'block';
    if (paypalForm) paypalForm.style.display = 'none';
  });

  paypalCard?.addEventListener('click', () => {
    paypalRadio.checked = true;
    paypalCard.classList.add('selected');
    bankCard?.classList.remove('selected');
    if (paypalForm) paypalForm.style.display = 'block';
    if (bankForm) bankForm.style.display = 'none';
  });

  // Upload de comprobante
  document.getElementById('proofUpload')?.addEventListener('change', (e) => {
    const input = e.target as HTMLInputElement;
    const fileName = document.getElementById('fileName');
    if (input.files && input.files[0] && fileName) {
      fileName.textContent = `Archivo seleccionado: ${input.files[0].name}`;
    }
  });

  // Confirmar pago bancario
  document.getElementById('confirmBank')?.addEventListener('click', async () => {
    const fileInput = document.getElementById('proofUpload') as HTMLInputElement;
    
    if (!fileInput.files || !fileInput.files[0]) {
      (window as any).showNotification(
        'Por favor sube el comprobante de pago',
        'warning',
        'Comprobante Requerido'
      );
      return;
    }

    await processOrder('bank_transfer');
  });

  // Pago con PayPal
  document.getElementById('paypalButton')?.addEventListener('click', async () => {
    (window as any).showNotification(
      'Redirigiendo a PayPal...',
      'info',
      'Procesando'
    );
    
    // Simular redirección a PayPal
    setTimeout(async () => {
      await processOrder('paypal');
    }, 1500);
  });

  async function processOrder(paymentMethod: string) {
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = '/login';
      return;
    }

    const cart = JSON.parse(localStorage.getItem('cart') || '[]');

    try {
      const response = await fetch(`${API_URL}/orders`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
          items: cart.map((item: any) => ({
            product_id: parseInt(item.id),
            quantity: item.quantity
          }))
        })
      });

      if (response.ok) {
        localStorage.removeItem('cart');
        window.dispatchEvent(new Event('cartUpdated'));
        
        (window as any).showNotification(
          `Pago procesado exitosamente mediante ${paymentMethod === 'bank_transfer' ? 'transferencia bancaria' : 'PayPal'}`,
          'success',
          '¡Compra Realizada!'
        );
        
        setTimeout(() => {
          window.location.href = '/ordenes';
        }, 2000);
      } else {
        (window as any).showNotification(
          'Hubo un problema al procesar tu orden',
          'error',
          'Error'
        );
      }
    } catch (error) {
      console.error('Error:', error);
      (window as any).showNotification(
        'No se pudo conectar con el servidor',
        'error',
        'Error de Conexión'
      );
    }
  }

  loadCart();
</script>
